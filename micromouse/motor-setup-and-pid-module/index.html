<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-micromouse/motor-setup-and-pid-module" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">Motor Setup and PID Module | IEEE at UCLA Project Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://projects.ieeebruins.com/micromouse/motor-setup-and-pid-module"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Motor Setup and PID Module | IEEE at UCLA Project Docs"><meta data-rh="true" name="description" content="Overview"><meta data-rh="true" property="og:description" content="Overview"><link data-rh="true" rel="icon" href="/img/logo_ieee.svg"><link data-rh="true" rel="canonical" href="https://projects.ieeebruins.com/micromouse/motor-setup-and-pid-module"><link data-rh="true" rel="alternate" href="https://projects.ieeebruins.com/micromouse/motor-setup-and-pid-module" hreflang="en"><link data-rh="true" rel="alternate" href="https://projects.ieeebruins.com/micromouse/motor-setup-and-pid-module" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.18354a95.css">
<script src="/assets/js/runtime~main.62184d40.js" defer="defer"></script>
<script src="/assets/js/main.46815c93.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo_ieee.svg" alt="IEEE Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo_ieee.svg" alt="IEEE Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">IEEE at UCLA Project Docs</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Docs</a><a href="https://ieeebruins.com" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">ieeebruins.com<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Welcome</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/micromouse/">Micromouse</a><button aria-label="Collapse sidebar category &#x27;Micromouse&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/micromouse/power-module">Power Module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/micromouse/motors-and-encoders-module">Motors and Encoders Module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/micromouse/ir-sensors-module">IR Sensors Module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/micromouse/microcontroller-module">Microcontroller Module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/micromouse/stm32cubeide-module">STM32CubeIDE Module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/micromouse/motor-setup-and-pid-module">Motor Setup and PID Module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/micromouse/ir-code-module">IR Code Module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/micromouse/floodfill-module">Floodfill Module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/micromouse/q-and-a">Q&amp;A</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/micromouse/aamc">AAMC</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/pocket-racers/">Pocket Racers</a><button aria-label="Expand sidebar category &#x27;Pocket Racers&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/DAV/">DAV</a><button aria-label="Expand sidebar category &#x27;DAV&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/WRAP/">WRAP</a><button aria-label="Expand sidebar category &#x27;WRAP&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/micromouse/"><span itemprop="name">Micromouse</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Motor Setup and PID Module</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Motor Setup and PID Module</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2>
<ol>
<li><a href="#motor-installation">Motor Installation</a>
<ol>
<li><a href="#soldering-on-the-h-bridge">Soldering on the h-bridge</a></li>
<li><a href="#installing-the-jst-cables">Installing the JST cables</a></li>
</ol>
</li>
<li><a href="#software-setup">Software Setup</a>
<ol>
<li><a href="#step-1-import-code-templates">Step 1: Import Code Templates</a></li>
<li><a href="#step-2-configure-encoders">Step 2: Configure Encoders</a></li>
<li><a href="#step-3-encoder-code">Step 3: Encoder Code!</a></li>
<li><a href="#step-4-configure-motors">Step 4: Configure Motors</a></li>
<li><a href="#step-5-motor-code">Step 5: Motor Code!</a></li>
</ol>
</li>
<li><a href="#driving-with-pid">Driving with PID</a>
<ol>
<li><a href="#part-1---straight-line-pid">Part 1: Straight Line PID</a>
<ol>
<li><a href="#step-1-importing-code-templates">Step 1: Importing Code Templates</a></li>
<li><a href="#step-2-enable-systick">Step 2: Enable Systick</a></li>
<li><a href="#step-3-drive-in-a-straight-line">Step 3: Drive in a Straight Line</a></li>
</ol>
</li>
<li><a href="#part-2---segmented-pid">Part 2: Segmented PID</a>
<ol>
<li><a href="#step-1-implement-all-functions-in-pidc">Step 1: Implement all functions in pid.c</a></li>
<li><a href="#step-2-turning">Step 2: Turning</a></li>
<li><a href="#step-3-moving-a-fixed-distance">Step 3: Moving a fixed distance</a></li>
<li><a href="#step-4-optional-acceleration">Step 4: Acceleration (optional)</a></li>
<li><a href="#step-5-traversing-a-fixed-path">Step 5: Traversing a fixed path</a></li>
</ol>
</li>
</ol>
</li>
</ol>
<p>In this module, you will continue learning about the STM32CubeIDE, and get the motors working on your mouse. Furthermore, you will learn how to read encoder counts, and use them to implement PID control to make your mouse drive straight and be able to turn!</p>
<p>There&#x27;s a LOT of code for this module, so if you&#x27;re stuck or want to verify your answers, you can check them <a href="https://drive.google.com/drive/folders/1gwBB0U-VkeGecnpUbbHFzOwJ33mFW20H?usp=drive_link" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h1>Motor Installation</h1>
<p>Before you start using your motors, you need to solder on the components needed to make your motors move! Make sure you solder on the entire h-bridge schematic from the Motors &amp; Encoders Module along with the jst cables.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="soldering-on-the-h-bridge">Soldering on the h-bridge<a href="#soldering-on-the-h-bridge" class="hash-link" aria-label="Direct link to Soldering on the h-bridge" title="Direct link to Soldering on the h-bridge">​</a></h2>
<p>When you solder on your h-bridge, make sure that you solder it on in the correct orientation. The tiny triangle on one of the corners of your h-bridge IC should correspond to the little triangle on the silkscreen of your pcb. If you want to be 100% sure you’re doing this correctly, look at your pcb schematic in fusion to double check!</p>
<p>Along with the h-bridge, now’s a good time to solder on the 4 decoupling capacitors that go with the h-bridge.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="installing-the-jst-cables">Installing the JST cables<a href="#installing-the-jst-cables" class="hash-link" aria-label="Direct link to Installing the JST cables" title="Direct link to Installing the JST cables">​</a></h2>
<p>The JST cables for the encoders are a bit of a pain to put together, so here’s some detailed instructions on how to get them installed.</p>
<ul>
<li>Cut the cables in half, such that each of the cables are about 1.5” long</li>
<li>Strip the ends of the cables (using a stripping tool, there’s a bunch in the lab)<!-- -->
<ul>
<li>You’ll want to strip enough off that you can solder, but not so much that it shortens your cable significantly.</li>
</ul>
</li>
<li>Your cables should now look something like this: (imagine these are colorful cables :)</li>
</ul>
<p><img loading="lazy" alt="alt_text" src="/assets/images/image3-d0531d7414c073b0d643b2ad5fea1fca.jpg" title="image_tooltip" width="1999" height="1205" class="img_ev3q"></p>
<p>Note the stripped ends on the right hand side of the image</p>
<ul>
<li>Now, lay the cables on the mouse such that the wires are oriented correctly. The green wire is ground, so make sure you orient it correctly based on your pcb layout.<!-- -->
<ul>
<li>Double check to ensure you have the cables oriented properly in your own schematics!</li>
</ul>
</li>
<li>Solder each wire in a line, making sure not to swap any of the connections.<!-- -->
<ul>
<li>This is a little tricky to do. Something that might make it easier is to tape down the wires (the colorful part) after inserting the stripped wires through the holes. This way, you can easily flip the board without worrying about the connector falling out!</li>
<li>You could also try to do this one wire connection at a time, retaping the connector every time you solder on another wire.</li>
</ul>
</li>
<li>Once you’re done, the connections should look like this:</li>
</ul>
<p><img loading="lazy" alt="alt_text" src="/assets/images/image14-b862267b2780399dea9eadcec0d62e9d.png" title="image_tooltip" width="1999" height="1500" class="img_ev3q"></p>
<ul>
<li>After you’re done, triple check that your cables are soldered on correctly! You might fry something if there’s any swapped cables!</li>
</ul>
<h1>Software Setup</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-1-import-code-templates">Step 1: Import Code Templates<a href="#step-1-import-code-templates" class="hash-link" aria-label="Direct link to Step 1: Import Code Templates" title="Direct link to Step 1: Import Code Templates">​</a></h2>
<p>To save you a little time, we made some code templates that you will complete for this assignment. Download all the files <a href="https://drive.google.com/drive/folders/1fLAvUncXzfA2LUG03xG1epKAGCCahB2J?usp=sharing" target="_blank" rel="noopener noreferrer">here</a> and add them to the appropriate folders in your project (.h files into Inc, .c files into Src).</p>
<p>Note: you should be able to drag and drop the files into the folders in CubeIDE. This may lead CubeIDE to ask you whether you want to copy the files or just reference them. We recommend choosing to make a copy into the project directory, as this helps keep everything organized (and prevents issues later).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-2-configure-encoders">Step 2: Configure Encoders<a href="#step-2-configure-encoders" class="hash-link" aria-label="Direct link to Step 2: Configure Encoders" title="Direct link to Step 2: Configure Encoders">​</a></h2>
<p>Now you need to configure the pins. We will be using a feature on our MCU called hardware encoders, which, as evidenced by the name, uses internal hardware to implement the counting logic covered in lecture. In the Device Configuration Tool in CubeIDE (if you can’t find it, open up the [project_name].ioc file from the project explorer in the left sidebar), set the following pins as such:</p>
<table><thead><tr><th><strong>Pin</strong></th><th><strong>Setting</strong></th><th><strong>User Label</strong></th></tr></thead><tbody><tr><td>PA8</td><td>TIM1_CH1</td><td>LeftEncoderCh1</td></tr><tr><td>PA9</td><td>TIM1_CH2</td><td>LeftEncoderCh2</td></tr><tr><td>PA0</td><td>TIM2_CH1</td><td>RightEncoderCh1</td></tr><tr><td>PA1</td><td>TIM2_CH2</td><td>RightEncoderCh2</td></tr></tbody></table>
<p><img loading="lazy" alt="alt_text" src="/assets/images/image9-9270f0346aacbf0e7d92d8d71204f67d.png" title="image_tooltip" width="475" height="438" class="img_ev3q"></p>
<ul>
<li>Note: we chose these pins for the encoders because they are some of the few pins that support <strong>hardware encoders</strong>. If we used different pins, we would need to do a bit more complicated code</li>
<li>A timer is basically a counter that enables you to do a variety of tasks requiring precise time intervals. There are many timers on the MCU, each one having multiple channels. The channels of a timer can each do separate tasks, but they have to share that same timer.</li>
<li>Now you will need to configure the timer settings. Expand the Timers dropdown in the sidebar towards the left and select TIM2.</li>
</ul>
<p><img loading="lazy" alt="alt_text" src="data:image/png;base64,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" title="image_tooltip" width="182" height="199" class="img_ev3q"></p>
<ul>
<li>In the tab that opens up, set Combined Channels to Encoder Mode.</li>
</ul>
<p><img loading="lazy" alt="alt_text" src="/assets/images/image11-e946e5c75a0ec8f7845be7b5f67bff7e.png" title="image_tooltip" width="497" height="277" class="img_ev3q"></p>
<ul>
<li>Once you enable Encoder Mode, down below some settings should appear. In the Parameter Settings tab, set Counter Period to 65535 and set Encoder Mode to Encoder Mode TI1 and TI2.</li>
</ul>
<p><img loading="lazy" alt="alt_text" src="/assets/images/image4-4703121c42a85f8dbcac63ae7a06d16e.png" title="image_tooltip" width="671" height="414" class="img_ev3q"></p>
<ul>
<li>Now, repeat everything we just did with Timer 2 but with Timer 1 by selecting TIM1 in the left sidebar.</li>
<li>NOTE: The counter period in this context is the maximum number of encoder counts that can be stored before the value resets.<!-- -->
<ul>
<li>For example, if it was set to 50, then when rotating the wheel forward, the recorded number of encoder counts would count up from zero to 50, and if the wheel continued turning forwards the value would reset to 0 before continuing to count up.</li>
<li>The MCU register storing the encoder counts on Timer 8 is 16 bits, so it can keep track of at most 65535, or 2^16 - 1, encoder counts. However, due to the nuances of how integers are stored in the MCU (feel free to Google the Two’s Complement representation of integers), the range of possible encoder values is -32768 to 32767.</li>
<li>You may notice that Timer 2 has a 32 bit register, evidenced by the text “AutoReload Register - 32 bits value” after Counter Period. Even though Timer 2’s counter period could be set higher, we set both to 65535 so they behave similarly. Our MCU does not have 2 separate 32 bit timer registers that can be used concurrently (Timer 2 and Timer 5 are both 32 bit, but cannot be used in encoder mode at the same time), so we settle for 16 bit counter periods.</li>
</ul>
</li>
<li>NOTE: The encoder mode refers to how the MCU detects encoder changes. Our encoders have 2 outputs, so to take advantage of both we use Encoder Mode TI1 and TI2. This will give us 360 encoder counts per revolution.</li>
<li>If we instead used, for example, Encoder Mode TI1, the MCU would only look for changes in the signal attached to the TIM#_CH1 pin, and we would effectively cut our resolution in half and get 180 encoder counts per revolution.</li>
<li>Feel free to play around with the settings and observe their effects, but obviously we want the highest resolution possible so make sure to change back any changes you make afterwards!</li>
<li>Click the generate code button!</li>
</ul>
<p><img loading="lazy" alt="alt_text" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAgCAYAAAAFQMh/AAADP0lEQVRYCe2W3WsTaRTG8y/4J6yCIri6oCKrsHdeeKGgFyusgtBbUWRF3BURUVDQm2V3WWGXtGrbmOxamjZJG/NRk8kkTdOkiUmTtM3HzLRJpYV+6lhQl98yI9QkUy1U11zowIGZ93w8Z57nvPOOiSZdppWVFZphpoXFJZphpsmnKs0wkzL9gmbYF+BPRvtnTLU0tYRUebYu1UVlkQlpTrfy5PK68XLlGSVl0RCnUy1XlohFBMRw1BBQu9UK8gJef4ju7l46LVZc/QN6A7Uxjfe5bB6v20VRnq+rrQOXlHnsXe3Yu7vqnI1FxMEniGKYfD5PT48Ts/k+2lpjXO1zOCzS+tcvjJdm6+J0YGlqmcRIhkRyrM5ZW0C7D0VS9PY6cDgctLW1YzZ36muNcbXP2TGFSDRhkHF1qt+vsUqpPIkgRPD5BnC6XHR02LFY3ASDAmVp6p0Nf5DGo3EPYtsB+lp/QBCjeL1+rFY3tr+DPOpsIW4/TjYZQKk+NzTwXo3Lk4uEQiHEcMyYmPQhmPczZtvGUNcpgqFBHfiBtR+rLUA6dIXZ9AUGH55iIjdsyE+l83g8HsNkr1KtVFV0azg0Yr0/km7fTKVvLyN9ZwgKkRrgx2SES7ya+ZXpJ7cY8d82ACvTKvIaTOjAmg6pkQSxYeOExhznyVq2MvP4IJX4z3hcrbTf+5M28x2ctqvMRnfxKvs1RedeMt5zBuDx8RIhIUhJWajz6cDaot/bj38gWOfUpjPl/olUxw5mwt/zsnqTucJlcoET5HyHmI/v4d/sV6jRTTx9tIlS+KwhP55I0tP9DwVprs63SrVGh1QxDkc6cBuh9Vuk4AlU5TrqxElej+3k9fhuXhRaUOVrFH3HGby7j4mEra641rhcVQ1bSVtfBX6XxrmUwJD3DzLOI0gDBxnu3MassIXl5HcU/MeQhy6S8ZxmONCx5oxsWGOtO0mukOw5Svj+Hty/b2f04WZG7d/Q/9sORMthks4WJLlqeFstd8Maa8la15I8RbmsUCwUyPjOkbAfI9p3Q/+wvAFV1wTesMZvgBv+y6rLKJUltMNlTX/Nllxf45rg9Yp9DP/b4foC/D8z8BlSXZLnaIb9B1UXp+bpQC6cAAAAAElFTkSuQmCC" title="image_tooltip" width="30" height="32" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-3-encoder-code">Step 3: Encoder Code!<a href="#step-3-encoder-code" class="hash-link" aria-label="Direct link to Step 3: Encoder Code!" title="Direct link to Step 3: Encoder Code!">​</a></h2>
<ul>
<li>
<p>Navigate to your main.c. In the main function, between the USER CODE BEGIN/END 2 comments (right before the while loop code), add the following:</p>
<p>HAL_TIM_Encoder_Start(&amp;htim1, TIM_CHANNEL_ALL);
HAL_TIM_Encoder_Start(&amp;htim2, TIM_CHANNEL_ALL);</p>
</li>
<li>
<p>Towards the top of main.c, define the following two variables between the USER CODE BEGIN/END PV comments (PV is for **Private Variables) **that will keep track of our encoder counts:</p>
<p>int16_t left_counts = 0;
int16_t right_counts = 0;</p>
</li>
<li>
<p>One last step: we want to be able to access the stored encoder counts value! Between the USER CODE BEGIN/END WHILE comments, add the following two lines of code that update the value of the encoders from the timers:</p>
<p>left_counts = (int16_t) TIM1-&gt;CNT;
right_counts = (int16_t) TIM2-&gt;CNT;</p>
</li>
<li>
<p>Now we can look at the values of these variables while the program is executing using a CubeIDE feature called Live Expressions.</p>
</li>
<li>
<p>To begin, make sure your mouse is powered on and your programmer is connected. Start the debug session with Debug As &gt; STM32 and start your program. (If you forgot how to do these steps, refer to the detailed instructions at the end of assignment 1A).</p>
</li>
<li>
<p>A sidebar should have appeared towards the right (assuming you switched perspectives to debug when launching your program; if not then press the debug icon in the upper right hand corner). Navigate to the Live Expressions tab.</p>
</li>
</ul>
<p><img loading="lazy" alt="alt_text" src="/assets/images/image13-7a8254b8de374c2854ccdc365305d180.png" title="image_tooltip" width="678" height="189" class="img_ev3q"></p>
<ul>
<li>Click Add new expression and enter the name of the variable you want to keep track of and click enter. Do this for both of our variables (the type and value fields should automatically be populated):</li>
</ul>
<p><img loading="lazy" alt="alt_text" src="/assets/images/image5-9b676c331d90491f5ee5fb525ef61faf.png" title="image_tooltip" width="678" height="205" class="img_ev3q"></p>
<ul>
<li>That’s it! If you haven’t already, click the resume button (f8). Now, you should be able to manually turn your wheels and see the encoder counts go up when they are turned forwards and down when they are turned backwards!</li>
</ul>
<p><img loading="lazy" alt="alt_text" src="/assets/images/image15-96f380a37e4323a200abe820497d94b4.png" title="image_tooltip" width="681" height="136" class="img_ev3q"></p>
<ul>
<li>If you’ve made it to this step, congratulations on getting your encoders working! Reading them directly using (int16_t) TIM#-&gt;CNT everywhere could work, but is a little confusing to read. Since you will be reading encoders a lot in your code (Foreshadowing for PID?), complete the code template in the encoders.c file.<!-- -->
<ul>
<li>The code here should just be one or two lines per function where you access the encoder values, so nothing fancy</li>
<li>Recommended: Try to make spinning the wheels forward yield positive results when read from the “left_counts” and “right_counts” variables</li>
</ul>
</li>
<li>Go back to main.c and include encoders.h between the USER CODE BEGIN/END Includes comments.</li>
<li>Go back to where you previously set right_counts and left_counts in the while loop. Replace the (int16_t) TIM#-&gt;CNT bits with getLeftEncoderCounts and getRightEncoderCounts.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-4-configure-motors">Step 4: Configure Motors<a href="#step-4-configure-motors" class="hash-link" aria-label="Direct link to Step 4: Configure Motors" title="Direct link to Step 4: Configure Motors">​</a></h2>
<ul>
<li>It is pretty exciting getting your encoders set up and being able to see the counts respond to manually turning the wheels. However, you aren’t allowed to push your mouse through the maze, so next we are going to configure your motors!</li>
<li>To generate PWM signals, we will be making use of timers on the MCU.</li>
<li>In the Device Configuration Tool window, configure the following pins as such:</li>
</ul>
<table><thead><tr><th><strong>Pin</strong></th><th><strong>Setting</strong></th></tr></thead><tbody><tr><td>PB6</td><td>TIM4_CH1</td></tr><tr><td>PB7</td><td>TIM4_CH2</td></tr><tr><td>PB8</td><td>TIM4_CH3</td></tr><tr><td>PB9</td><td>TIM4_CH4</td></tr></tbody></table>
<p><img loading="lazy" alt="alt_text" src="/assets/images/image2-e23c806a94814981c741f678fafd5fd3.png" title="image_tooltip" width="247" height="131" class="img_ev3q"></p>
<ul>
<li>Select TIM4 from the Timers dropdown in the left sidebar, and set the Channel1 dropdown to PWM Generation CH1</li>
</ul>
<p><img loading="lazy" alt="alt_text" src="/assets/images/image16-141cb2bcd4291b99d35880a5f6c21c97.png" title="image_tooltip" width="847" height="284" class="img_ev3q"></p>
<ul>
<li>Do the same for channels 2-4</li>
<li>Below in the Parameter Settings tab, change Counter Period to 3199.</li>
</ul>
<p><img loading="lazy" alt="alt_text" src="/assets/images/image7-79b3d751e906457542e7699f7f4cf5eb.png" title="image_tooltip" width="671" height="312" class="img_ev3q"></p>
<ul>
<li>NOTE: The counter period is chosen with regards to the maximum PWM frequency our motor driver can handle.</li>
<li>Here’s how we calculated the value of 3199 (for those of you who are curious)<!-- -->
<ul>
<li>The MCU has a clock speed of 16 MHz, and it is able to do something each clock cycle. The counter period is a subdivision of this 16 MHz; you can think of it as the period of our PWM wave in units of clock cycles.</li>
<li>The timer’s counter starts at zero and counts up each clock cycle to a certain value (in our case) 3199 before looping back to zero.</li>
<li>By setting what is called the channel’s pulse value, we can set how many counts out of the timer’s counter period the output pin should be set high. For example, if the pulse value were 1599, the pin connected to the timer channel would stay on for the first 1600 clock cycles and be off for the remaining 1600. If the pulse value were 799, the pin would be high for 800 clock cycles and low for 2400. The pin will repeat this every time the counter period resets to zero.</li>
<li>In the description section of the L293D’s datasheet on the first page (<a href="https://www.st.com/resource/en/datasheet/l293d.pdf" target="_blank" rel="noopener noreferrer">https://www.st.com/resource/en/datasheet/l293d.pdf</a>) it states “this device is suitable for use in switching applications at frequencies up to 5 kHz.”</li>
<li>So, we use 3199 as the counter period in order to achieve an effective PWM frequency of 5 kHz, since 16 MHz / 3200 = 5kHz (we divide by 3200 since the timer’s counter starts with zero rather than 1, so zero to 3199 is 3200 distinct counts).</li>
<li>Our PWM duty cycle is calculated as (Pulse / Counter Period) _ 100%. So if our pulse was 800, Our duty cycle would be (800 / 3200) _ 100% = 25%.</li>
</ul>
</li>
<li>Go to the NVIC Settings tab and check the box to enable the TIM4 global interrupt.</li>
</ul>
<p><img loading="lazy" alt="alt_text" src="/assets/images/image12-c81265361bed88bd6c458fabf23e6c99.png" title="image_tooltip" width="672" height="61" class="img_ev3q"></p>
<ul>
<li>NOTE: Channels sharing a timer (e.g. channels 1-4 of timer 4) will have the same counter period and counter, but the different channels can utilize the timer’s counter differently and have their own pulse values.</li>
<li>Click the code generation button! \</li>
</ul>
<p><img loading="lazy" alt="alt_text" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAgCAYAAAAFQMh/AAADP0lEQVRYCe2W3WsTaRTG8y/4J6yCIri6oCKrsHdeeKGgFyusgtBbUWRF3BURUVDQm2V3WWGXtGrbmOxamjZJG/NRk8kkTdOkiUmTtM3HzLRJpYV+6lhQl98yI9QkUy1U11zowIGZ93w8Z57nvPOOiSZdppWVFZphpoXFJZphpsmnKs0wkzL9gmbYF+BPRvtnTLU0tYRUebYu1UVlkQlpTrfy5PK68XLlGSVl0RCnUy1XlohFBMRw1BBQu9UK8gJef4ju7l46LVZc/QN6A7Uxjfe5bB6v20VRnq+rrQOXlHnsXe3Yu7vqnI1FxMEniGKYfD5PT48Ts/k+2lpjXO1zOCzS+tcvjJdm6+J0YGlqmcRIhkRyrM5ZW0C7D0VS9PY6cDgctLW1YzZ36muNcbXP2TGFSDRhkHF1qt+vsUqpPIkgRPD5BnC6XHR02LFY3ASDAmVp6p0Nf5DGo3EPYtsB+lp/QBCjeL1+rFY3tr+DPOpsIW4/TjYZQKk+NzTwXo3Lk4uEQiHEcMyYmPQhmPczZtvGUNcpgqFBHfiBtR+rLUA6dIXZ9AUGH55iIjdsyE+l83g8HsNkr1KtVFV0azg0Yr0/km7fTKVvLyN9ZwgKkRrgx2SES7ya+ZXpJ7cY8d82ACvTKvIaTOjAmg6pkQSxYeOExhznyVq2MvP4IJX4z3hcrbTf+5M28x2ctqvMRnfxKvs1RedeMt5zBuDx8RIhIUhJWajz6cDaot/bj38gWOfUpjPl/olUxw5mwt/zsnqTucJlcoET5HyHmI/v4d/sV6jRTTx9tIlS+KwhP55I0tP9DwVprs63SrVGh1QxDkc6cBuh9Vuk4AlU5TrqxElej+3k9fhuXhRaUOVrFH3HGby7j4mEra641rhcVQ1bSVtfBX6XxrmUwJD3DzLOI0gDBxnu3MassIXl5HcU/MeQhy6S8ZxmONCx5oxsWGOtO0mukOw5Svj+Hty/b2f04WZG7d/Q/9sORMthks4WJLlqeFstd8Maa8la15I8RbmsUCwUyPjOkbAfI9p3Q/+wvAFV1wTesMZvgBv+y6rLKJUltMNlTX/Nllxf45rg9Yp9DP/b4foC/D8z8BlSXZLnaIb9B1UXp+bpQC6cAAAAAElFTkSuQmCC" title="image_tooltip" width="30" height="32" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-5-motor-code">Step 5: Motor Code!<a href="#step-5-motor-code" class="hash-link" aria-label="Direct link to Step 5: Motor Code!" title="Direct link to Step 5: Motor Code!">​</a></h2>
<ul>
<li>
<p>First, add the following in main.c between the USER CODE BEGIN/END 2 comments:</p>
<p>HAL_TIM_PWM_Start(&amp;htim4, TIM_CHANNEL_1);</p>
<p>HAL_TIM_PWM_Start(&amp;htim4, TIM_CHANNEL_2);</p>
<p>HAL_TIM_PWM_Start(&amp;htim4, TIM_CHANNEL_3);</p>
<p>HAL_TIM_PWM_Start(&amp;htim4, TIM_CHANNEL_4);</p>
</li>
<li>
<p>To keep our code organized, we are going to be putting some functions that handle motor logic into separate .c and .h files. Go to motors.c and follow the commented instructions.</p>
</li>
<li>
<p>WARNING: This is mentioned in the comments in motors.c but just in case: NEVER SET BOTH THE FORWARD AND BACKWARD CHANNELS TO NON-ZERO VALUES AT THE SAME TIME. As mentioned in lecture, this can destroy your h-bridge. When setting a channel, always set the other channel to zero first.</p>
</li>
<li>
<p>With your functions complete, it should now be pretty easy to get your motors spinning! First, go to main.c and between the USER CODE BEGIN/END Includes comments include motors.h.</p>
</li>
<li>
<p>Now, after the HAL<em>TIM_PWM</em>… lines, set each motor to a different speed and direction by calling setMotorRPWM and setMotorLPWM!</p>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="driving-with-pid">DRIVING WITH PID<a href="#driving-with-pid" class="hash-link" aria-label="Direct link to DRIVING WITH PID" title="Direct link to DRIVING WITH PID">​</a></h2>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="part-1---straight-line-pid">Part 1 - Straight Line PID<a href="#part-1---straight-line-pid" class="hash-link" aria-label="Direct link to Part 1 - Straight Line PID" title="Direct link to Part 1 - Straight Line PID">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-1-importing-code-templates">Step 1: Importing Code Templates<a href="#step-1-importing-code-templates" class="hash-link" aria-label="Direct link to Step 1: Importing Code Templates" title="Direct link to Step 1: Importing Code Templates">​</a></h3>
<p>To save you a little time, we have some code templates that you will complete for this assignment. Download all the files <a href="https://drive.google.com/drive/folders/1YAYAiOikv_qf6AqWy-Ixw_rMMY3ggH_6?usp=sharing" target="_blank" rel="noopener noreferrer">here</a> and add them to the appropriate folders in your project (.h files into Inc, .c files into Src).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-2-enable-systick">Step 2: Enable Systick<a href="#step-2-enable-systick" class="hash-link" aria-label="Direct link to Step 2: Enable Systick" title="Direct link to Step 2: Enable Systick">​</a></h3>
<p>Systick is one of the functions that we will use on our MCU. It is an interrupt that is called every millisecond, and is asynchronous, meaning it will execute regularly every millisecond regardless of what is going on in the main function.</p>
<p>Systick is perfect for implementing PID control, since the code will execute at regular time intervals. This is especially important for implementing derivative sub-controllers, since we perform those calculations using discrete data points from different points in time.</p>
<p>In your project’s Src folder, open the file named stm32f4xx_it.c</p>
<p>Between the USER CODE BEGIN/END Includes comments, include systick.h</p>
<p>Still in stm32f4xx_it.c file, scroll down and call the SysTickFunction() between the USER CODE BEGIN/END SysTick_IRQn 1 comments.</p>
<p>Press the save all button :</p>
<p>Before continuing, let’s explain briefly how the code is organized and executed:</p>
<ul>
<li>Systick.c contains our SysTickFunction(), which gets called every millisecond.</li>
<li>SysTickFunction should call an update function within pid.c, which is where all the logic corresponding to PID will be implemented and motor speeds are adjusted to help the mouse achieve the goal.</li>
<li>You will instruct pid.c on what to do (i.e. set the goal state) by calling functions in controller.c. These functions can be things like move (int numberOfCells) or turn (int numberOfDegrees).</li>
</ul>
<p>This is just a hypothetical way to cleanly organize your code--deviate as you see fit. Our code templates have suggestions about what each function does and some tips on how to implement them.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-3-drive-in-a-straight-line">Step 3: Drive in a Straight Line<a href="#step-3-drive-in-a-straight-line" class="hash-link" aria-label="Direct link to Step 3: Drive in a Straight Line" title="Direct link to Step 3: Drive in a Straight Line">​</a></h3>
<p>Driving straight is a good place to start for implementing your PID control system. You should implement the following functions in order to accomplish this:</p>
<ul>
<li>SysTickFunction in systick.c</li>
<li>updatePID in pid.c</li>
</ul>
<p>There is some helpful pseudocode in the code templates folder for completing this assignment. Follow it if you get stuck!</p>
<p>Tips:</p>
<ul>
<li>Sometimes the signs of the calculations can be tricky (i.e. add angle correction or subtract it) so try playing around with these. If the motors spin really fast and the error keeps growing, try switching some pluses to minuses or vice versa</li>
<li>Use live expressions to track your calculated error while you debug your rat</li>
</ul>
<p>Once you get your code set up, you will need to tune your PD constants. At first your mouse may instantly start spinning out of control, or drive forwards in a very jittery manner. Here are some tips for tuning your PD constants:</p>
<ul>
<li>Start with kP and kD both zero. Slowly increase kP until your mouse oscillates a little at the goal.</li>
<li>Next, increase kD until the oscillations go away.</li>
<li>Once you have your rough values for kP and kD, experiment with them to try to reach the goal as fast as possible without overshooting.</li>
<li>Keep your batteries charged, since your motors may behave differently at lower voltage.</li>
<li>Use a spreadsheet to keep track of which constants you’ve tried. This way, you can easily revert back to constants that worked. Write notes about how the system behaved with each set of constants you try.</li>
</ul>
<p>Remember, change your constants very gradually! They will likely be quite small. Tuning may take a while, but once your rat’s PID is tuned it will be able to go straight! And the results will be very satisfying. If you are following the pseudo code, to make the mouse drive straight, you only need to tune the <strong>kPw</strong> and <strong>kDw</strong> constants! The distance error is kept at a constant non-zero value to allow for continuous “straight” motion.</p>
<p>That’s all for this part of the assignment. We only implemented a few of the functions in this part of the assignment, but the rest of the next part of the assignment will be very doable if/when you understand conceptually what is going on. Show us your mouse driving straight (or take and submit a video) to get checked off!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="part-2---segmented-pid">Part 2 - Segmented PID<a href="#part-2---segmented-pid" class="hash-link" aria-label="Direct link to Part 2 - Segmented PID" title="Direct link to Part 2 - Segmented PID">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-1-implement-all-functions-in-pidc">Step 1: Implement all functions in pid.c<a href="#step-1-implement-all-functions-in-pidc" class="hash-link" aria-label="Direct link to Step 1: Implement all functions in pid.c" title="Direct link to Step 1: Implement all functions in pid.c">​</a></h3>
<p>In Part 1 you only had to implement updatePID in pid.c. Now, you should implement the rest of the functions <strong>before continuing</strong>.</p>
<p>There are some changes you should also make to updatePID. Refer to the pseudocode document for some pointers.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-2-turning">Step 2: Turning<a href="#step-2-turning" class="hash-link" aria-label="Direct link to Step 2: Turning" title="Direct link to Step 2: Turning">​</a></h3>
<p>You will now be working to get your mouse to turn at right angles. The first step is to measure approximately how many encoder counts constitute a 90 degree turn in either direction.</p>
<ul>
<li>A good way to do this is to temporarily comment out the part of updatePID that sets motor speed (so it doesn’t try to make corrections during your measurement!) and then using live expressions to view the encoder counts.</li>
<li>Set your mouse on a flat surface (maybe the lab maze? or just a table) and turn your mouse 90 degrees. Make sure you push down with enough pressure that the wheels don’t slip along the surface.</li>
<li>Assuming both encoders started at zero, one should now have a positive value and the other a negative value. Take note of the magnitude of their difference. This is the angle error setting to turn 90 degrees.</li>
<li>For increased accuracy, you could consider turning your mouse some multiple of 90 degrees, and dividing by the number of turns you made.</li>
<li>Don’t forget to uncomment the motor speed setting code afterwards!</li>
</ul>
<p>Next, implement the turn function in controller.c. It should set the goal angle in pid.c to some multiple of the amount of encoder counts you measured earlier for a 90 degree turn.</p>
<p>With this done, call turn(1) in main.c before the while loop. Theoretically, your mouse should turn 90 degrees. However, you may notice a couple issues:</p>
<ul>
<li>Your mouse turns extremely fast, and possibly overshoots by a large amount. This is because there is no limit on your angleCorrection.</li>
<li>The mouse continues to oscillate/jitter once it has completed the turn.</li>
<li>You hear a very annoying (yet sorta quiet) high pitched noise.</li>
</ul>
<p>Here are some tips to fix these issues:</p>
<ul>
<li>The high pitched noise and the jittering are caused by the mouse trying to move “too slow.” For example, if your mouse overshoots by only a couple encoders counts, the PD correction is going to be very small… so small that it is not enough to get the motors to rotate, but enough so that you can hear the sound of them trying to.</li>
<li>Your mouse may move extremely quickly when turning—so much so that it goes out of control. This is because there is no limit on the angleCorrection value, so the correction may force the motors to spin at their top speed.</li>
<li>To fix both of these issues, you should limit the angleCorrection! Use the implementation of the limitPWM function in motors.c as inspiration for how to do this.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-3-moving-a-fixed-distance">Step 3: Moving a fixed distance<a href="#step-3-moving-a-fixed-distance" class="hash-link" aria-label="Direct link to Step 3: Moving a fixed distance" title="Direct link to Step 3: Moving a fixed distance">​</a></h3>
<p>Finally, it is time to teach your mouse how to move fixed distances in a straight line! As with turning, the first step is to figure out how far it is you want your mouse to travel.</p>
<ul>
<li>Measure the number of encoder counts it takes to move your mouse in a straight line from the center of one maze square to another.</li>
<li>Your “current distance” is taken to be the average of your left and right encoder counts.</li>
</ul>
<p>Once you have measured how far your mouse should travel to traverse one maze square in terms of encoder counts, it is time to implement the movement. Follow the pseudocode document for Part 2 for some implementation suggestions if you get stuck!</p>
<p>You should also implement move() in controller.c. It will look very similar to turn().</p>
<p>As with your angle PD constants, you will need to take some time to tune your distance constants.</p>
<p>Once you finish, try calling move(1) in main.c. If all goes well, your mouse should move forwards one maze cell!</p>
<p>Tips:</p>
<ul>
<li>We recommend you limit the distance and angle corrections individually. For example, if your max motor pwm is 0.8, perhaps you could limit your distanceCorrection to be between -0.5 and 0.5, and your angleCorrection to be between -0.3 and 0.3. That way their sum will always be in the valid range.</li>
<li>The distance constants kPx and kDx matter much less than the angle constants kPw and kDw. If something is wrong with your rat’s movement, it is most likely an issue with the turning constants.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-4-optional-acceleration">Step 4 (Optional): Acceleration<a href="#step-4-optional-acceleration" class="hash-link" aria-label="Direct link to Step 4 (Optional): Acceleration" title="Direct link to Step 4 (Optional): Acceleration">​</a></h3>
<p>If you run the move function right now, you might notice that the mouse goes immediately to your max speed when the movement starts. This is just due to the nature of the PD controller. Unfortunately, this instant speedup is a bit hard in the real world because **it takes time for objects to accelerate **(good ol’ <em>F = ma</em>).</p>
<p><img loading="lazy" alt="alt_text" src="/assets/images/image16-141cb2bcd4291b99d35880a5f6c21c97.png" title="image_tooltip" width="847" height="284" class="img_ev3q"></p>
<p>What your velocity may look like if you reach max</p>
<p>speed with gradual acceleration</p>
<p>You may or may not find it worth it to implement gradual acceleration and deceleration when changing speeds. This will be especially useful if you are going for higher speeds and traversing multiple cells with one move function.</p>
<p>The actual implementation should be simple:</p>
<ol>
<li>Define an acceleration constant</li>
<li>Compare Motor Speed calculated by the PD controller w/ Previous Motor Speed</li>
<li>If difference between two motor speeds &gt; Acceleration Constant<!-- -->
<ol>
<li>Motor speed = Previous Motor Speed Acceleration Constant</li>
</ol>
</li>
</ol>
<p>This should be relatively consistent because updatePID() is run every millisecond by Systick. This acceleration step is optional because it is much more useful when you are traveling multiple cells in one move function like move(5) and want to reach higher speeds. You will most likely not have to travel multiple cells at once yet, but this may be useful in Winter and Spring quarter when we learn how to “remember the layout” of the maze using <strong>Floodfill</strong>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-5-traversing-a-fixed-path">Step 5: Traversing a fixed path<a href="#step-5-traversing-a-fixed-path" class="hash-link" aria-label="Direct link to Step 5: Traversing a fixed path" title="Direct link to Step 5: Traversing a fixed path">​</a></h3>
<p>If you have reached this point, you are almost there! 99% of the work was effectively implementing your turn() and move() functions.</p>
<p>The final step is to utilize your turn and move functions (probably in main.c before the while loop?) to traverse a path of your choosing through a maze. Remember, your mouse must move at least 6 cells and make at least 3 turns!</p>
<p>Remember to exit out of the move and turn functions once the mouse has achieved a reasonably low error with respect to the goal. Not doing so will cause the program to not move onto the next action command!</p>
<p>After you finish… CONGRATULATIONS! You have taught your mouse how to blindly follow a fixed path using PID control. Once you give your mouse eyes (IR sensors) in the next assignment, it will be able to follow any path!</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/UCLA-IEEE/projects.ieeebruins.com/tree/main/docs/micromouse/motor-setup-and-pid-module.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/micromouse/stm32cubeide-module"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">STM32CubeIDE Module</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/micromouse/ir-code-module"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">IR Code Module</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#soldering-on-the-h-bridge" class="table-of-contents__link toc-highlight">Soldering on the h-bridge</a></li><li><a href="#installing-the-jst-cables" class="table-of-contents__link toc-highlight">Installing the JST cables</a></li><li><a href="#step-1-import-code-templates" class="table-of-contents__link toc-highlight">Step 1: Import Code Templates</a></li><li><a href="#step-2-configure-encoders" class="table-of-contents__link toc-highlight">Step 2: Configure Encoders</a></li><li><a href="#step-3-encoder-code" class="table-of-contents__link toc-highlight">Step 3: Encoder Code!</a></li><li><a href="#step-4-configure-motors" class="table-of-contents__link toc-highlight">Step 4: Configure Motors</a></li><li><a href="#step-5-motor-code" class="table-of-contents__link toc-highlight">Step 5: Motor Code!</a></li><li><a href="#driving-with-pid" class="table-of-contents__link toc-highlight">DRIVING WITH PID</a></li><li><a href="#part-1---straight-line-pid" class="table-of-contents__link toc-highlight">Part 1 - Straight Line PID</a><ul><li><a href="#step-1-importing-code-templates" class="table-of-contents__link toc-highlight">Step 1: Importing Code Templates</a></li><li><a href="#step-2-enable-systick" class="table-of-contents__link toc-highlight">Step 2: Enable Systick</a></li><li><a href="#step-3-drive-in-a-straight-line" class="table-of-contents__link toc-highlight">Step 3: Drive in a Straight Line</a></li></ul></li><li><a href="#part-2---segmented-pid" class="table-of-contents__link toc-highlight">Part 2 - Segmented PID</a><ul><li><a href="#step-1-implement-all-functions-in-pidc" class="table-of-contents__link toc-highlight">Step 1: Implement all functions in pid.c</a></li><li><a href="#step-2-turning" class="table-of-contents__link toc-highlight">Step 2: Turning</a></li><li><a href="#step-3-moving-a-fixed-distance" class="table-of-contents__link toc-highlight">Step 3: Moving a fixed distance</a></li><li><a href="#step-4-optional-acceleration" class="table-of-contents__link toc-highlight">Step 4 (Optional): Acceleration</a></li><li><a href="#step-5-traversing-a-fixed-path" class="table-of-contents__link toc-highlight">Step 5: Traversing a fixed path</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">More of us!</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/RREtsea" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://instagram.com/uclaieee" target="_blank" rel="noopener noreferrer" class="footer__link-item">Instagram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">© 2025 IEEE at UCLA. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>